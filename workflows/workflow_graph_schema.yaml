# workflow_graph_schema.yaml
version: "1.0"
metadata:
  name: "ClaudeCode Interactive Graph Workflow"
  description: "åŸºäºå›¾ç®—æ³•çš„åˆ†æ­¥éª¤å¼•å¯¼å¼å·¥ä½œæµï¼Œæ”¯æŒHuman-in-the-loopç¡®è®¤æœºåˆ¶"
  graph_theory:
    type: "DAG"  # æœ‰å‘æ— ç¯å›¾ï¼Œç¡®ä¿å·¥ä½œæµå¯ç»ˆæ­¢
    traversal: "BFS"  # å¹¿åº¦ä¼˜å…ˆï¼Œæ”¯æŒå¹¶è¡Œå­ä»»åŠ¡
    checkpoint_strategy: "node_level"  # æ¯ä¸ªèŠ‚ç‚¹å‰ä¿å­˜çŠ¶æ€

# çŠ¶æ€æœºå®šä¹‰ï¼ˆå…¨å±€çŠ¶æ€ç®¡ç†ï¼‰
state_machine:
  context:
    user_input: null      # åŸå§‹è¾“å…¥ï¼ˆæ–‡æœ¬/å›¾ç‰‡URLï¼‰
    current_node: "start" # å½“å‰æ‰§è¡ŒèŠ‚ç‚¹ID
    history: []           # æ‰§è¡Œè·¯å¾„è®°å½•
    artifacts: {}         # ä¸­é—´äº§ç‰©å­˜å‚¨
  checkpoints:
    auto_save: true
    rollback_capable: true  # æ”¯æŒå›é€€åˆ°ä»»æ„èŠ‚ç‚¹

# èŠ‚ç‚¹ç±»å‹å®šä¹‰ï¼ˆå›¾èŠ‚ç‚¹åˆ†ç±»ï¼‰
node_types:
  INPUT: { icon: "ğŸ“¥", description: "æ¥æ”¶ç”¨æˆ·è¾“å…¥" }
  ANALYSIS: { icon: "ğŸ”", description: "AIåˆ†æå¤„ç†" }
  DECISION: { icon: "âš¡", description: "æ¡ä»¶åˆ¤æ–­åˆ†æ”¯" }
  CONFIRM: { icon: "â¸ï¸", description: "ç­‰å¾…ç”¨æˆ·ç¡®è®¤" }
  SUBGRAPH: { icon: "ğŸ“¦", description: "åµŒå¥—å­å·¥ä½œæµ" }
  OUTPUT: { icon: "âœ…", description: "æœ€ç»ˆè¾“å‡º" }

# å·¥ä½œæµå›¾å®šä¹‰ï¼ˆæ ¸å¿ƒï¼‰
workflow_graph:
  nodes:
    # æ ¹èŠ‚ç‚¹ï¼šè¾“å…¥è¯†åˆ«
    - id: "start"
      type: "INPUT"
      name: "multimodal_input"
      config:
        accept_types: ["text", "image"]
        prompt: "è¯·æä¾›æ‚¨çš„éœ€æ±‚æè¿°æˆ–å‚è€ƒå›¾ç‰‡ï¼Œæˆ‘å°†ä¸ºæ‚¨æ‹†è§£ä»»åŠ¡..."
      next: ["parse_input"]

    # èŠ‚ç‚¹1ï¼šæ™ºèƒ½è§£æï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
    - id: "parse_input"
      type: "ANALYSIS"
      name: "intent_parser"
      skill: "claude-code-intent-parser"
      config:
        system_prompt: |
          åˆ†æç”¨æˆ·è¾“å…¥ï¼Œè¯†åˆ«ï¼š
          1. ä»»åŠ¡ç±»å‹ï¼ˆcoding/design/writing/analysisï¼‰
          2. å¤æ‚åº¦è¯„åˆ†ï¼ˆ1-10ï¼‰
          3. å¯æ‹†è§£å­ä»»åŠ¡åˆ—è¡¨
        output_schema:
          task_type: "string"
          complexity: "integer"
          subtasks: "array"
      next: ["complexity_check"]

    # èŠ‚ç‚¹2ï¼šå¤æ‚åº¦å†³ç­–ï¼ˆè‡ªåŠ¨è·¯ç”±ï¼‰
    - id: "complexity_check"
      type: "DECISION"
      name: "routing_decision"
      conditions:
        - if: "complexity <= 3"
          then: "simple_task_flow"
        - if: "complexity > 3 && complexity <= 7"
          then: "moderate_decomposition"
        - else: "complex_decomposition"
      edges:
        simple_task_flow: "direct_execution"
        moderate_decomposition: "step_planning"
        complex_decomposition: "recursive_planning"

    # åˆ†æ”¯Aï¼šç®€å•ä»»åŠ¡ç›´æ¥æ‰§è¡Œ
    - id: "direct_execution"
      type: "CONFIRM"
      name: "confirm_simple"
      config:
        message_template: |
          æ£€æµ‹åˆ°ç®€å•ä»»åŠ¡ï¼š{task_type}
          æ‰§è¡Œè®¡åˆ’ï¼š{plan}
          æ˜¯å¦ç«‹å³æ‰§è¡Œï¼Ÿ
        options: ["execute", "modify", "cancel"]
      next:
        execute: ["executor"]
        modify: ["parse_input"]
        cancel: ["abort"]

    # åˆ†æ”¯Bï¼šä¸­ç­‰å¤æ‚åº¦ - æ­¥éª¤è§„åˆ’
    - id: "step_planning"
      type: "ANALYSIS"
      name: "step_breakdown"
      skill: "claude-code-planner"
      config:
        strategy: "sequential"
        max_steps: 5
        require_confirmation_each: true
      next: ["interactive_executor"]

    # åˆ†æ”¯Cï¼šå¤æ‚ä»»åŠ¡ - é€’å½’å­å›¾
    - id: "recursive_planning"
      type: "SUBGRAPH"
      name: "master_planner"
      subgraph_ref: "hierarchical_decomposition"
      config:
        depth_limit: 3  # é˜²æ­¢æ— é™é€’å½’
        parallel_branches: true  # ç‹¬ç«‹å­ä»»åŠ¡å¹¶è¡Œ
      next: ["merge_results"]

    # æ ¸å¿ƒèŠ‚ç‚¹ï¼šäº¤äº’å¼æ‰§è¡Œå¼•æ“ï¼ˆå¸¦ç¡®è®¤ï¼‰
    - id: "interactive_executor"
      type: "CONFIRM"
      name: "step_by_step_controller"
      config:
        mode: "iterative_confirmation"
        step_template:
          pre_exec: |
            ## æ­¥éª¤ {step_number}/{total_steps}
            **ç›®æ ‡**: {step_goal}
            **è¾“å…¥**: {dependencies}
            **é¢„è®¡äº§å‡º**: {output_artifact}
            
            å‡†å¤‡æ‰§è¡Œæ­¤æ­¥éª¤ï¼Ÿ
          post_exec: |
            æ­¥éª¤ {step_number} å®Œæˆï¼Œäº§å‡ºï¼š
            ```{artifact_preview}```
            æ˜¯å¦ç»§ç»­ä¸‹ä¸€æ­¥ï¼Ÿ
        control_options:
          - "continue"      # ç»§ç»­ä¸‹ä¸€æ­¥
          - "retry"         # é‡åšå½“å‰æ­¥
          - "modify"        # ä¿®æ”¹å½“å‰æ­¥å‚æ•°
          - "branch"        # ä»è¿™é‡Œåˆ†å‰æ–°è·¯å¾„
          - "rollback"      # å›é€€åˆ°æŸèŠ‚ç‚¹
      next:
        continue: ["dynamic_router"]
        retry: ["self"]  # è‡ªå¾ªç¯
        modify: ["step_planning"]
        branch: ["subgraph_spawn"]
        rollback: ["state_restorer"]

    # åŠ¨æ€è·¯ç”±ï¼šæ ¹æ®æ‰§è¡Œç»“æœå†³å®šä¸‹ä¸€æ­¥
    - id: "dynamic_router"
      type: "DECISION"
      name: "execution_router"
      conditions:
        - if: "remaining_steps > 0"
          then: "interactive_executor"
        - else: "validation"

    # å­å›¾ç”Ÿæˆå™¨ï¼ˆå¤„ç†åˆ†å‰éœ€æ±‚ï¼‰
    - id: "subgraph_spawn"
      type: "SUBGRAPH"
      name: "adaptive_branch"
      dynamic: true  # è¿è¡Œæ—¶ç”Ÿæˆå­å›¾
      config:
        inherit_context: true
        isolation_level: "context_copy"
      next: ["merge_results"]

    # ç»“æœåˆå¹¶ï¼ˆé’ˆå¯¹å¹¶è¡Œå­ä»»åŠ¡ï¼‰
    - id: "merge_results"
      type: "ANALYSIS"
      name: "synthesizer"
      skill: "claude-code-synthesis"
      config:
        merge_strategy: "hierarchical"
        conflict_resolution: "interactive"  # å†²çªæ—¶è¯¢é—®ç”¨æˆ·
      next: ["validation"]

    # è´¨é‡éªŒè¯èŠ‚ç‚¹ï¼ˆäººæœºåä½œï¼‰
    - id: "validation"
      type: "CONFIRM"
      name: "quality_gate"
      config:
        message_template: |
          ## ä»»åŠ¡æ‰§è¡Œå®Œæˆ
          **æˆæœæ‘˜è¦**: {summary}
          **è€—æ—¶**: {duration}
          
          è¯·é€‰æ‹©ï¼š
          - âœ… æ¥å—å¹¶ç»“æŸ
          - ğŸ”§ éœ€è¦ä¿®æ”¹ï¼ˆæŒ‡å®šèŒƒå›´ï¼‰
          - ğŸ”„ å®Œå…¨é‡åš
          - â• å¢åŠ æ–°æ­¥éª¤
      next:
        accept: ["finalize"]
        modify: ["partial_retry"]
        redo: ["parse_input"]
        extend: ["step_planning"]

    # éƒ¨åˆ†é‡è¯•æœºåˆ¶ï¼ˆç²¾å‡†ä¿®å¤ï¼‰
    - id: "partial_retry"
      type: "ANALYSIS"
      name: "diff_analyzer"
      config:
        mode: "selective_rollback"
        preserve_valid_work: true
      next: ["interactive_executor"]

    # ç»ˆæ€èŠ‚ç‚¹
    - id: "finalize"
      type: "OUTPUT"
      name: "delivery"
      config:
        format: "markdown"
        include_thought_chain: true
        export_artifacts: true

    - id: "abort"
      type: "OUTPUT"
      name: "termination"
      config:
        status: "cancelled"
        cleanup_temp: true

  # è¾¹å®šä¹‰ï¼ˆæ˜¾å¼æ§åˆ¶æµ + æ¡ä»¶è¾¹ï¼‰
  edges:
    # æ˜¾å¼è¾¹ï¼ˆå¼ºè¿æ¥ï¼‰
    explicit:
      - from: "start"
        to: "parse_input"
        label: "è‡ªåŠ¨è§£æ"
    
    # æ¡ä»¶è¾¹ï¼ˆè¿è¡Œæ—¶å†³å®šï¼‰
    conditional:
      - from: "complexity_check"
        to: "direct_execution"
        condition: "complexity <= 3"
        weight: 1
      
      - from: "complexity_check"
        to: "step_planning"
        condition: "complexity <= 7"
        weight: 2
    
    # åé¦ˆè¾¹ï¼ˆæ”¯æŒå¾ªç¯ä¼˜åŒ–ï¼‰
    feedback:
      - from: "validation"
        to: "parse_input"
        label: "å…¨å±€é‡åš"
        max_iterations: 3  # é˜²æ­¢æ— é™å¾ªç¯

# å­å·¥ä½œæµå®šä¹‰ï¼ˆé€’å½’ç»“æ„ç¤ºä¾‹ï¼‰
sub_workflows:
  hierarchical_decomposition:
    description: "å¤æ‚ä»»åŠ¡é€’å½’æ‹†è§£ä¸ºå­ä»»åŠ¡å›¾"
    nodes:
      - id: "decompose"
        type: "ANALYSIS"
        name: "task_splitter"
        config:
          strategy: "mcts"  # è’™ç‰¹å¡æ´›æ ‘æœç´¢å¯»æ‰¾æœ€ä¼˜æ‹†è§£
          min_granularity: "atomic_task"
        next: ["parallel_dispatch"]
      
      - id: "parallel_dispatch"
        type: "SUBGRAPH"
        name: "worker_pool"
        replication_mode: "foreach_subtask"  # ä¸ºæ¯ä¸ªå­ä»»åŠ¡å¤åˆ¶å­å›¾
        subgraph_ref: "atomic_execution"
        config:
          max_parallel: 3  # å¹¶å‘æ§åˆ¶
        next: ["subtask_merge"]

# è¿è¡Œæ—¶é…ç½®ï¼ˆæ‰§è¡Œç­–ç•¥ï¼‰
runtime:
  execution_engine:
    type: "event_driven"
    persistence: "memory+file"  # æ”¯æŒæ–­ç‚¹ç»­ä¼ 
    
  human_in_the_loop:
    default_action: "pause_await_input"
    timeout: "infinite"  # ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼Œæ— è¶…æ—¶
    ui_mode: "rich_interactive"  # æ”¯æŒæŒ‰é’®/è¾“å…¥æ¡†/å›¾ç‰‡é¢„è§ˆ
    
  error_handling:
    strategy: "node_isolation"
    on_failure:
      - action: "pause_and_ask"
        message: "æ­¥éª¤ {node_id} å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•/è·³è¿‡/ç»ˆæ­¢ï¼Ÿ"
      - action: "auto_retry"
        max_attempts: 2
      - action: "escalate_to_parent"
        if_subgraph: true
        
  observability:
    graph_visualization: true  # å®æ—¶æ¸²æŸ“å½“å‰æ‰§è¡Œè·¯å¾„å›¾
    state_inspection: true     # å…è®¸æŸ¥çœ‹ä¸­é—´çŠ¶æ€
    thought_chain_logging: true # è®°å½•å†³ç­–è¿‡ç¨‹