# .claude/workflows/new-component.yaml
name: new-component
description: ä»é›¶å¼€å‘ Vue 3 ç»„ä»¶ï¼ˆå«ç±»å‹ã€æµ‹è¯•ã€Storybookï¼‰
version: "2.0.0"
author: "vue-team"

# è§¦å‘å™¨é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªåŠ¨åŒ–ï¼‰
trigger:
  type: manual  # manual | file_change | git_hook
  prompt_template: |
    åˆ›å»ºæ–°ç»„ä»¶ï¼š{{user_input}}
    è¯·æä¾›ï¼š
    - ç»„ä»¶åç§°
    - åŠŸèƒ½æè¿°
    - å…³é”® Props

# ä¸Šä¸‹æ–‡å®šä¹‰ï¼ˆæ­¥éª¤é—´æ•°æ®ä¼ é€’ï¼‰
context:
  project_path: "{{env.PROJECT_ROOT}}"
  tech_stack: "{{file('../context/tech-stack.json')}}"
  conventions: "{{file('../context/vue-conventions.md')}}"

# æ‰§è¡Œæ­¥éª¤
steps:
  # ========== æ­¥éª¤ 1: éœ€æ±‚åˆ†æ ==========
  - id: analyze
    name: requirement-analysis
    description: åˆ†æç”¨æˆ·éœ€æ±‚ï¼Œæå–å…³é”®ä¿¡æ¯
    agent: vue-architect
    # ä¸ä½¿ç”¨ skillï¼Œçº¯å¯¹è¯åˆ†æ
    prompt: |
      ## ä»»åŠ¡
      åˆ†æç”¨æˆ·çš„ç»„ä»¶éœ€æ±‚ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯ã€‚
      
      ## ç”¨æˆ·è¾“å…¥
      {{trigger.user_input}}
      
      ## é¡¹ç›®è§„èŒƒï¼ˆå‚è€ƒï¼‰
      {{context.conventions}}
      
      ## è¾“å‡ºè¦æ±‚ï¼ˆJSON æ ¼å¼ï¼‰
      ```json
      {
        "component_name": "ç»„ä»¶åï¼ˆPascalCaseï¼‰",
        "description": "è¯¦ç»†åŠŸèƒ½æè¿°",
        "category": "ç»„ä»¶åˆ†ç±»ï¼šdisplay | form | feedback | navigation | data",
        "complexity": "å¤æ‚åº¦ï¼šsimple | medium | complex",
        "props": [
          {
            "name": "propå",
            "type": "TypeScriptç±»å‹",
            "required": true/false,
            "default": "é»˜è®¤å€¼",
            "description": "è¯´æ˜"
          }
        ],
        "emits": ["äº‹ä»¶ååˆ—è¡¨"],
        "slots": ["æ’æ§½ååˆ—è¡¨"],
        "features": ["éœ€è¦æ”¯æŒçš„ç‰¹æ€§ï¼šloading | error | empty | async | v-model"],
        "dependencies": ["ä¾èµ–çš„ç»„ä»¶æˆ–composable"],
        "estimated_files": 3
      }
      ```
      
      åªè¾“å‡º JSONï¼Œä¸è¦æœ‰å…¶ä»–è¯´æ˜ã€‚
    
    outputs:
      analysis: "{{parse_json(response)}}"  # å­˜å‚¨è§£æåçš„ JSON
      component_name: "{{parse_json(response).component_name}}"
    
    validation:
      - field: "analysis.component_name"
        rule: "matches_regex('^[A-Z][a-zA-Z0-9]+$')"
        error_msg: "ç»„ä»¶åå¿…é¡»æ˜¯ PascalCase"
      - field: "analysis.complexity"
        rule: "in_list(['simple', 'medium', 'complex'])"
    
    on_error: retry  # retry | skip | abort

  # ========== æ­¥éª¤ 2: ç”Ÿæˆç»„ä»¶ä»£ç  ==========
  - id: generate
    name: generate-sfc
    description: ç”Ÿæˆå•æ–‡ä»¶ç»„ä»¶
    agent: vue-architect
    skill: sfc-generator  # ä½¿ç”¨ Skill
    
    # æ¡ä»¶ï¼šä»…å½“åˆ†ææˆåŠŸæ—¶æ‰§è¡Œ
    condition: "{{steps.analyze.status == 'success'}}"
    
    inputs:
      component_name: "{{steps.analyze.outputs.component_name}}"
      description: "{{steps.analyze.outputs.analysis.description}}"
      props: "{{steps.analyze.outputs.analysis.props}}"
      emits: "{{steps.analyze.outputs.analysis.emits}}"
      slots: "{{steps.analyze.outputs.analysis.slots}}"
      features: "{{steps.analyze.outputs.analysis.features}}"
      styling: "tailwind"  # ä»é…ç½®è¯»å–æˆ–ç¡¬ç¼–ç 
    
    outputs:
      sfc_code: "{{response.code}}"
      sfc_filename: "{{response.filename}}"
      composables_needed: "{{response.composables_needed}}"
    
    # æ–‡ä»¶æ“ä½œï¼šè‡ªåŠ¨å†™å…¥
    post_action:
      type: write_file
      path: "{{context.project_path}}/src/components/{{steps.generate.outputs.sfc_filename}}"
      content: "{{steps.generate.outputs.sfc_code}}"
      confirm: true  # å†™å…¥å‰è¯¢é—®ç¡®è®¤

  # ========== æ­¥éª¤ 3: ç”Ÿæˆç»„åˆå¼å‡½æ•°ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰==========
  - id: composables
    name: generate-composables
    description: ç”Ÿæˆæ‰€éœ€çš„ç»„åˆå¼å‡½æ•°
    agent: composable-expert
    skill: composable-generator
    
    # ä»…å½“éœ€è¦ composables æ—¶æ‰§è¡Œ
    condition: "{{steps.generate.outputs.composables_needed | length > 0}}"
    
    # å¾ªç¯ï¼šä¸ºæ¯ä¸ªéœ€è¦çš„ composable ç”Ÿæˆ
    loop: "{{steps.generate.outputs.composables_needed}}"
    loop_var: composable_name
    
    inputs:
      name: "{{composable_name}}"
      purpose: "æ”¯æŒ {{steps.analyze.outputs.component_name}} ç»„ä»¶"
      source_type: "external_api"
      return_structure: "standard"
    
    outputs:
      composable_code: "{{response.code}}"
      composable_filename: "{{response.filename}}"
    
    post_action:
      type: write_file
      path: "{{context.project_path}}/src/composables/{{steps.composables.outputs.composable_filename}}"
      content: "{{steps.composables.outputs.composable_code}}"

  # ========== æ­¥éª¤ 4: Props ç±»å‹ä¼˜åŒ– ==========
  - id: types
    name: optimize-types
    description: æå–å’Œä¼˜åŒ– TypeScript ç±»å‹
    agent: type-guardian
    
    prompt: |
      ä¼˜åŒ–ä»¥ä¸‹ Vue ç»„ä»¶çš„ç±»å‹å®šä¹‰ï¼š
      
      ## å½“å‰ä»£ç 
      ```vue
      {{steps.generate.outputs.sfc_code}}
      ```
      
      ## ä»»åŠ¡
      1. å°† Props æ¥å£æå–åˆ°ç‹¬ç«‹çš„ types/{{component_name}}.types.ts
      2. ç¡®ä¿æ‰€æœ‰å¤æ‚ç±»å‹éƒ½æœ‰æ˜ç¡®æ¥å£
      3. æ·»åŠ ç±»å‹å®ˆå«å‡½æ•°ï¼ˆå¦‚ isUserï¼‰
      4. ä¼˜åŒ–æ³›å‹ä½¿ç”¨
      
      è¾“å‡ºï¼š
      - types.ts æ–‡ä»¶å†…å®¹
      - æ›´æ–°åçš„ç»„ä»¶ä»£ç ï¼ˆimport ç±»å‹ï¼‰
    
    outputs:
      types_code: "{{extract_code_block(response, 'typescript')}}"
      updated_sfc: "{{extract_code_block(response, 'vue')}}"
    
    post_action:
      - type: write_file
        path: "{{context.project_path}}/src/components/types/{{steps.analyze.outputs.component_name}}.types.ts"
        content: "{{steps.types.outputs.types_code}}"
      - type: update_file
        path: "{{context.project_path}}/src/components/{{steps.generate.outputs.sfc_filename}}"
        content: "{{steps.types.outputs.updated_sfc}}"

  # ========== æ­¥éª¤ 5: æ ·å¼ä¼˜åŒ– ==========
  - id: styling
    name: optimize-styles
    description: ä¼˜åŒ– Tailwind ç±»å
    agent: styling-expert
    skill: tailwind-optimizer
    
    inputs:
      description: "{{steps.analyze.outputs.analysis.description}}"
      existing_classes: "{{extract_classnames(steps.generate.outputs.sfc_code)}}"
      context: "{{steps.analyze.outputs.analysis.category}}"
    
    outputs:
      optimized_classes: "{{response.optimized_classes}}"
      style_explanation: "{{response.explanation}}"
    
    # å†…è”æ›´æ–°ï¼šä¿®æ”¹ SFC ä¸­çš„ class
    post_action:
      type: modify_file
      path: "{{context.project_path}}/src/components/{{steps.generate.outputs.sfc_filename}}"
      operations:
        - type: replace
          pattern: 'class="([^"]*)"'
          replacement: 'class="{{steps.styling.outputs.optimized_classes}}"'

  # ========== æ­¥éª¤ 6: ç”Ÿæˆå•å…ƒæµ‹è¯• ==========
  - id: testing
    name: generate-tests
    description: ç”Ÿæˆ Vitest æµ‹è¯•æ–‡ä»¶
    agent: testing-guru
    
    prompt: |
      ä¸ºä»¥ä¸‹ Vue 3 ç»„ä»¶ç”Ÿæˆå•å…ƒæµ‹è¯•ï¼š
      
      ## ç»„ä»¶ä»£ç 
      ```vue
      {{steps.generate.outputs.sfc_code}}
      ```
      
      ## Props ç±»å‹
      {{steps.types.outputs.types_code}}
      
      ## è¦æ±‚
      1. ä½¿ç”¨ Vitest + Vue Test Utils
      2. æµ‹è¯•æ‰€æœ‰ Props çš„æ¸²æŸ“
      3. æµ‹è¯•æ‰€æœ‰ Emits äº‹ä»¶è§¦å‘
      4. æµ‹è¯• Slots å†…å®¹æ¸²æŸ“
      5. æµ‹è¯• loading/error çŠ¶æ€
      6. ä½¿ç”¨ @testing-library/vue é£æ ¼æŸ¥è¯¢
      7. è¦†ç›–ç‡ > 80%
      
      è¾“å‡ºå®Œæ•´çš„ {{component_name}}.spec.ts æ–‡ä»¶
      
    outputs:
      test_code: "{{extract_code_block(response, 'typescript')}}"
      test_cases: "{{response.test_cases_count}}"
    
    post_action:
      type: write_file
      path: "{{context.project_path}}/src/components/__tests__/{{steps.analyze.outputs.component_name}}.spec.ts"
      content: "{{steps.testing.outputs.test_code}}"

  # ========== æ­¥éª¤ 7: ç”Ÿæˆ Storybook æ•…äº‹ ==========
  - id: storybook
    name: generate-stories
    description: ç”Ÿæˆ Storybook æ•…äº‹
    agent: vue-architect
    skill: storybook-creator
    
    condition: "{{file_exists('src/stories')}}"
    
    inputs:
      component_code: "{{steps.types.outputs.updated_sfc}}"
      component_name: "{{steps.analyze.outputs.component_name}}"
      props_definition: "{{steps.analyze.outputs.analysis.props}}"
      variants: ["default", "loading", "empty", "error"]
    
    outputs:
      story_code: "{{response.code}}"
    
    post_action:
      type: write_file
      path: "{{context.project_path}}/src/stories/{{steps.analyze.outputs.component_name}}.stories.ts"
      content: "{{steps.storybook.outputs.story_code}}"

  # ========== æ­¥éª¤ 8: åˆ›å»ºç´¢å¼•å¯¼å‡º ==========
  - id: index
    name: update-index
    description: æ›´æ–°ç»„ä»¶åº“ç´¢å¼•
    agent: vue-architect
    
    prompt: |
      æ›´æ–° src/components/index.tsï¼Œæ·»åŠ æ–°ç»„ä»¶å¯¼å‡ºï¼š
      
      æ–°ç»„ä»¶: {{steps.analyze.outputs.component_name}}
      æ–‡ä»¶è·¯å¾„: ./{{steps.generate.outputs.sfc_filename}}
      
      ä¿æŒç°æœ‰å¯¼å‡ºé¡ºåºï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰ï¼Œæ·»åŠ æ–°å¯¼å‡ºã€‚
    
    post_action:
      type: update_file
      path: "{{context.project_path}}/src/components/index.ts"
      mode: append  # append | replace | smart_merge

  # ========== æ­¥éª¤ 9: æœ€ç»ˆå®¡æŸ¥ ==========
  - id: review
    name: final-review
    description: ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–å»ºè®®
    agent: review-master
    
    prompt: |
      å®¡æŸ¥ä»¥ä¸‹ç”Ÿæˆçš„ä»£ç è´¨é‡ï¼š
      
      ## ç»„ä»¶
      {{read_file(context.project_path + '/src/components/' + steps.generate.outputs.sfc_filename)}}
      
      ## æµ‹è¯•
      {{read_file(context.project_path + '/src/components/__tests__/' + steps.analyze.outputs.component_name + '.spec.ts')}}
      
      ## æ£€æŸ¥æ¸…å•
      - [ ] TypeScript ä¸¥æ ¼ç±»å‹
      - [ ] å¯è®¿é—®æ€§ (a11y)
      - [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆmemo, lazyï¼‰
      - [ ] ä»£ç é£æ ¼ä¸€è‡´æ€§
      - [ ] é”™è¯¯è¾¹ç•Œå¤„ç†
      
      è¾“å‡ºï¼š
      1. é€šè¿‡/ä¸é€šè¿‡
      2. å‘ç°çš„é—®é¢˜
      3. ä¿®å¤å»ºè®®ï¼ˆå¯ç›´æ¥åº”ç”¨çš„ä»£ç ï¼‰
    
    outputs:
      review_passed: "{{response.passed}}"
      issues: "{{response.issues}}"
      fixes: "{{response.fixes}}"
    
    # æ¡ä»¶æ‰§è¡Œï¼šæœ‰é—®é¢˜æ—¶è‡ªåŠ¨ä¿®å¤
    on_error:
      action: conditional_step
      next_step: auto_fix

  # ========== æ­¥éª¤ 10: ç”Ÿæˆæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰==========
  - id: docs
    name: generate-docs
    description: ç”Ÿæˆç»„ä»¶ä½¿ç”¨æ–‡æ¡£
    agent: vue-architect
    condition: "{{steps.analyze.outputs.analysis.complexity != 'simple'}}"
    
    prompt: |
      ä¸º {{steps.analyze.outputs.component_name}} ç”Ÿæˆ Markdown æ–‡æ¡£ï¼š
      
      åŒ…å«ï¼š
      - åŠŸèƒ½è¯´æ˜
      - Props è¡¨æ ¼
      - Events è¡¨æ ¼
      - Slots è¡¨æ ¼
      - ä½¿ç”¨ç¤ºä¾‹ï¼ˆ3ä¸ªä¸åŒåœºæ™¯ï¼‰
      - æ³¨æ„äº‹é¡¹
    
    outputs:
      docs_content: "{{response}}"
    
    post_action:
      type: write_file
      path: "{{context.project_path}}/docs/components/{{steps.analyze.outputs.component_name}}.md"
      content: "{{steps.docs.outputs.docs_content}}"

# å·¥ä½œæµè¾“å‡ºï¼ˆæ±‡æ€»ï¼‰
outputs:
  files_created:
    - "{{steps.generate.outputs.sfc_filename}}"
    - "{{steps.types.outputs.types_filename}}"
    - "{{steps.testing.outputs.test_filename}}"
    - "{{steps.storybook.outputs.story_filename}}"
  
  summary: |
    âœ… æˆåŠŸåˆ›å»ºç»„ä»¶ {{steps.analyze.outputs.component_name}}
    ğŸ“ æ–‡ä»¶æ•°: {{steps | length}}
    ğŸ§ª æµ‹è¯•ç”¨ä¾‹: {{steps.testing.outputs.test_cases}} ä¸ª
    {{#if steps.review.outputs.review_passed}}
    âœ¨ ä»£ç å®¡æŸ¥é€šè¿‡
    {{else}}
    âš ï¸ å‘ç° {{steps.review.outputs.issues | length}} ä¸ªé—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¿®å¤å»ºè®®
    {{/if}}

# åç½®é’©å­ï¼šé€šçŸ¥ã€ç»Ÿè®¡ç­‰
post_workflow:
  - type: log
    message: "ç»„ä»¶ {{component_name}} åˆ›å»ºå®Œæˆ"
  - type: update_stats
    metric: "components_created"
    value: 1